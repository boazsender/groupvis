/*! groupvis - v0.0.1 - 2012-11-29
* Copyright (c) 2012 ; Licensed MIT */
(function(e,t){var n=e.Tooltip=function(e){this.t=t.select("body").append("div").classed("bp-tooltip",!0).html(e)};n.prototype.show=function(e){this.t.style("visibility","visible"),this.update(e)},n.prototype.hide=function(e){this.t.style("visibility","hidden")},n.prototype.remove=function(e){this.t.remove()},n.prototype.update=function(e){this.t.style("top",e.pageY-10+"px").style("left",e.pageX+10+"px")}})(this,this.d3),function(e,t,n){var r=e.Tooltip,i=e.BubbleChart=function(e){e=e||{},this.el=e.el,this.data=e.data,this.users=e.users,this.width=e.width||950,this.height=e.height||440,this.color_mode="collaboratorCount",this.max_collaborators=0,this.template=e.template||null,this.center={x:this.width/2,y:this.height/2},this.owner_centers={owned:{x:this.width/3,y:this.height/2},forked:{x:this.width/3*2,y:this.height/2}};if(this.users){var r;this.user_centers={};if(this.users.length<5)for(r=0;r<this.users.length;r++)this.user_centers[this.users[r]]={x:this.width/this.users.length*(r+1),y:this.height/2};else{for(r=0;r<Math.ceil(this.users.length/2);r++)this.user_centers[this.users[r]]={x:this.width/Math.ceil(this.users.length/2)*(r+1),y:this.height/3};var i=1;for(r=Math.ceil(this.users.length/2);r<this.users.length;r++)this.user_centers[this.users[r]]={x:this.width/Math.floor(this.users.length/2)*i,y:this.height/3*2},i++}}this.layout_gravity=-0.01,this.damper=.1,this.vis=null,this.nodes=[],this.force=null,this.circles=null,this.fill_color=this.getColors(),this.fill_color_multi_user="#ddd",this.max_collaborators=t.max(t.map(t.pluck(this.data,"users"),function(e){return e.length})),this.radius_scale=n.scale.pow().exponent(.5).domain([0,this.max_collaborators]).range([0,18]),this.createNodes(),this.createVis()};i.prototype.createNodes=function(){t.each(this.data,function(e,t){var n={id:t,name:t,value:e.users.length,owner:e.owner||null,collaborators:e.users,radius:this.radius_scale(e.users.length),x:Math.random()*this.width,y:Math.random()*this.height};e.users.length>this.max_collaborators&&(this.max_collaborators=e.users.length),e.count===1?n.group="one":e.count===2?n.group="two":n.group="many",this.nodes.push(n)},this),this.nodes=t.sortBy(this.nodes,function(e,t){return t.value-e.value})},i.prototype.createVis=function(){var e=this;this.vis=n.select(this.el).append("svg").attr("width",this.width).attr("height",this.height).attr("id","svg_vis"),this.circles=this.vis.selectAll("circle").data(this.nodes,function(e){return e.id});var t=function(t){if(e.color_mode==="collaboratorCount")return e.fill_color(t.group);if(e.color_mode==="user")return t.count>1?e.fill_color_multi_user:e.fill_color(t.collaborators[0])};this.circles.enter().append("circle").classed("bp-circle",!0).attr("r",0).attr("fill",t).attr("stroke-width",2).attr("stroke",function(e){return n.rgb(t(e)).darker()}).attr("id",function(e){return"bubble_"+e.id}).on("mouseover",function(t){this.tooltip=new r(e.template?e.template({repo:t}):t.name),this.tooltip.show(event),t.owner!==null&&n.select(this).transition().attr("stroke-width",5)}).on("mouseout",function(){this.tooltip.hide(event),this.tooltip.remove(event),n.select(this).transition().attr("stroke-width",2)}).on("mousemove",function(){this.tooltip.update(event)}).on("click",function(e){e.owner!==null&&window.open("http://github.com/"+e.owner+"/"+e.name)}),this.circles.transition().duration(3e3).attr("r",function(e){return e.radius})},i.prototype.charge=function(e){return-Math.pow(e.radius,2)/6},i.prototype.start=function(){this.force=n.layout.force().nodes(this.nodes).size([this.width,this.height])},i.prototype.display=function(e){var t=this;this.force.gravity(this.layout_gravity).charge(this.charge).on("tick",function(n){t.circles.each(t[e].apply(t,[n.alpha])).attr("cx",function(e){return e.x}).attr("cy",function(e){return e.y})}),this.force.start()},i.prototype.moveTowardsCenter=function(e){var t=this;return function(n){n.x=n.x+(t.center.x-n.x)*(t.damper+.02)*e,n.y=n.y+(t.center.y-n.y)*(t.damper+.02)*e}},i.prototype.moveTowardsOwnerCenters=function(e){var t=this;return function(n){var r;n.owner!==null?r=t.owner_centers.owned:r=t.owner_centers.forked,n.x=n.x+(r.x-n.x)*(t.damper+.02)*e,n.y=n.y+(r.y-n.y)*(t.damper+.02)*e}},i.prototype.moveTowardsUsers=function(e){var t=this;return function(n){var r;n.owner!==null?r=t.user_centers[n.owner]:r={x:n.x,y:n.y>t.height/2?t.height+100:-100},n.x=n.x+(r.x-n.x)*(t.damper+.02)*e,n.y=n.y+(r.y-n.y)*(t.damper+.02)*e}},i.prototype.getColors=function(){if(this.color_mode==="user")return n.scale.category20().domain(Object.keys(this.users));if(this.color_mode==="size")return n.scale.category20b().domain(this.histogram);if(this.color_mode==="collaboratorCount")return n.scale.ordinal().domain(["one","two","many"]).range(["#EDD155","#7aa25c","#B86CAF"])}}(this,this._,this.d3),function(){var e=null,t=this.BubbleChart,n=this._,r=this.$,i,s={},o=[],u,a=r.Deferred(),f=a.promise();r.getJSON("data/bocoup_github.json").then(function(e){s=e.repos,o=e.histogram,u=e.users,a.resolve()}).fail(function(e){a.reject(e)}),f.then(function(){e=new t({data:s,el:"#bp_bubblechart",users:u,template:n.template("<div class='bp-tooltip-name'><%= repo.name %></div><% if (repo.owner) { %>  <div class='bp-tooltip-owner'>by <%= repo.owner %> </div><% } %><% if (repo.collaborators) { %><div>Contributors:</div><div class='bp-tooltip-contributors'><%= repo.collaborators.join(', ') %></div><% } %>")}),e.start(),e.display("moveTowardsCenter"),r("#bp_controls div").click(function(t){var n=t.target;e.display(n.id)})})}(this);